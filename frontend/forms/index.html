<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fill Form - EaseForm</title>
    <meta name="description" content="Submit your anonymous response - EaseForm">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <!-- Tailwind CSS -->
    <link href="/dist/output.css" rel="stylesheet">

    <!-- Supabase JS Client CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Core Utilities -->
    <script src="../config.js"></script>
    <script src="../utils/logger.js"></script>
    <script src="../utils/cache.js"></script>
    <script src="../utils/auth.js"></script>

    <!-- Auth Guard - Must run early -->
    <script>
        document.documentElement.style.display = 'none';
    </script>
    <script src="../utils/auth-guard.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            if (window.AuthGuard) window.AuthGuard.init();
        });
        setTimeout(() => { document.documentElement.style.display = ''; }, 0);
    </script>
    <script src="../utils/api.js"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Smooth transitions */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        /* Focus styles */
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Radio and checkbox custom styles */
        input[type="radio"]:checked {
            background-color: #6366f1;
            border-color: #6366f1;
        }

        input[type="checkbox"]:checked {
            background-color: #6366f1;
            border-color: #6366f1;
        }

        /* Pulse animation for anonymous badge */
        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .pulse-slow {
            animation: pulse-slow 3s ease-in-out infinite;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <a href="/" class="group flex items-center gap-1">
                    <span
                        class="text-xl font-bold tracking-tight text-gray-900 group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-indigo-600 group-hover:to-blue-600 transition-all duration-300">Ease</span>
                    <span
                        class="text-xl font-bold tracking-tight text-indigo-600 group-hover:text-gray-900 transition-colors duration-300">Form</span>
                    <div class="h-1.5 w-1.5 rounded-full bg-indigo-600 mb-1 animate-pulse"></div>
                </a>

                <!-- Anonymous Badge -->
                <div id="anonymous-badge"
                    class="hidden flex items-center space-x-2 px-3 py-1.5 bg-green-50 border border-green-200 rounded-full">
                    <div class="w-2 h-2 bg-green-500 rounded-full pulse-slow"></div>
                    <span class="text-xs font-medium text-green-700">Anonymous Form</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Loading State -->
    <div id="loading-state" class="py-16">
        <div class="max-w-2xl mx-auto px-4 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading form...</p>
        </div>
    </div>

    <!-- Main Content - Normal Form State -->
    <main class="py-8 pb-16 hidden" id="form-container">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">

            <!-- Form Info Section -->
            <section id="form-header" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-6">
                <!-- Will be populated by JavaScript -->
            </section>

            <!-- Form Questions -->
            <form id="response-form" class="space-y-6">
                <div id="questions-container">
                    <!-- Questions will be rendered here -->
                </div>

                <!-- Submit Button -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <button type="submit" id="submit-btn"
                        class="w-full sm:w-auto px-8 py-3 text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm hover:shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Submit Response
                    </button>
                    <p class="mt-3 text-xs text-gray-500">
                        By submitting, you confirm that your response is honest and complete.
                    </p>
                </div>
            </form>

        </div>
    </main>

    <!-- Error State -->
    <div id="error-state" class="hidden py-16">
        <div class="max-w-2xl mx-auto px-4 text-center">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-6">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
                <h2 id="error-title" class="text-2xl font-bold text-gray-900 mb-3">Form Not Found</h2>
                <p id="error-message" class="text-base text-gray-600 mb-8">
                    The form you're looking for doesn't exist or has been removed.
                </p>
                <a href="/"
                    class="inline-flex items-center px-6 py-3 text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Closed Form State -->
    <div id="closed-state" class="hidden py-16">
        <div class="max-w-2xl mx-auto px-4 text-center">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-6">
                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">This form is no longer accepting responses</h2>
                <p class="text-base text-gray-600 mb-8">
                    The form owner has closed this form. Thank you for your interest.
                </p>
                <a href="/"
                    class="inline-flex items-center px-6 py-3 text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Success State -->
    <div id="success-state" class="hidden py-16">
        <div class="max-w-2xl mx-auto px-4 text-center">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-6">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">Your response has been recorded</h2>
                <p class="text-base text-gray-600 mb-8">
                    Thank you for your feedback! Your anonymous response has been successfully submitted.
                </p>
                <a href="/"
                    class="inline-flex items-center px-6 py-3 text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Duplicate Submission State -->
    <div id="duplicate-state" class="hidden py-16">
        <div class="max-w-2xl mx-auto px-4 text-center">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 rounded-full mb-6">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">This form has already been submitted from this device
                </h2>
                <p class="text-base text-gray-600 mb-8">
                    To maintain data integrity and prevent duplicate responses, this form only allows one submission per
                    device. Your previous response has been recorded.
                </p>
                <a href="/"
                    class="inline-flex items-center px-6 py-3 text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-6 mt-12">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500">
                Powered by <a href="/" class="text-indigo-600 hover:text-indigo-700 font-medium">EaseForm</a> -
                Privacy-first forms
            </p>
        </div>
    </footer>

    <script>
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getFormIdFromURL() {
            var params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        function getOrCreateDeviceId() {
            var deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('device_id', deviceId);
                window.Logger.info('Device', 'Created new device ID');
            } else {
                window.Logger.debug('Device', 'Using existing device ID');
            }
            return deviceId;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        function showError(title, message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
        }

        function showClosedState() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('closed-state').classList.remove('hidden');
        }

        // ============================================
        // LOAD FORM
        // ============================================
        async function loadForm(formId) {
            try {
                window.Logger.info('Form', 'Loading form', formId);

                // Fetch form from API (Public endpoint)
                var renderForm = function (form) {
                    if (form.closed) {
                        window.Logger.info('Form', 'Form is closed');
                        showClosedState();
                        return;
                    }

                    // Render form
                    renderFormHeader(form);
                    renderQuestions(form.questions);

                    // Show anonymous badge if applicable
                    if (form.anonymous) {
                        document.getElementById('anonymous-badge').classList.remove('hidden');
                    }

                    // Show form container
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('form-container').classList.remove('hidden');

                    // Store form data for submission
                    window.currentForm = form;
                }

                var form = await window.API.forms.getPublic(formId, function (freshForm) {
                    window.Logger.debug('SWR', 'Updating public form with fresh data');
                    renderForm(freshForm);
                });

                window.Logger.info('Form', 'Form loaded');
                renderForm(form);
                return; // renderForm handles the rest

            } catch (error) {
                window.Logger.error('Form', 'Error loading form', error);

                if (error.status === 404) {
                    showError('Form Not Found', 'The form you\'re looking for doesn\'t exist or has been removed.');
                } else {
                    showError('Error Loading Form', error.message || 'An unexpected error occurred. Please try again later.');
                }
            }
        }

        // ============================================
        // RENDER FORM HEADER
        // ============================================
        function renderFormHeader(form) {
            var header = document.getElementById('form-header');

            var privacyNotice = '';
            if (form.anonymous) {
                var onePerDeviceText = form.one_response_per_device ? ' One response per device is allowed.' : '';
                privacyNotice = `
                    <div class="flex items-start space-x-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800">
                            <strong>Privacy Notice:</strong> We don't collect your email, name, or any identifying information.${onePerDeviceText}
                        </p>
                    </div>
                `;
            }

            header.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-900 mb-4">
                    ${escapeHtml(form.title)}
                </h1>
                ${form.description ? `<p class="text-base text-gray-600 mb-4">${escapeHtml(form.description)}</p>` : ''}
                ${privacyNotice}
            `;
        }

        // ============================================
        // RENDER QUESTIONS
        // ============================================
        // ============================================
        // RENDER QUESTIONS
        // ============================================
        function renderQuestions(questions) {
            const container = document.getElementById("questions-container");

            if (!container) {
                window.Logger.error('DOM', 'questions-container not found');
                return;
            }

            container.innerHTML = "";

            questions.forEach((question) => {
                // Default to short_answer if type is missing
                const type = question.type || 'short_answer';
                // window.Logger.debug('Form', 'Rendering question', {id: question.id, type: type});

                const div = document.createElement("div");
                div.className = "bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4";

                // Question Label
                let html = `
                    <label class="block text-base font-medium text-gray-900 mb-3">
                        ${escapeHtml(question.question)}
                        ${question.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                    </label>
                `;

                // Input field based on type
                if (type === 'short_answer') {
                    html += `
                        <input type="text" 
                            name="${question.id}" 
                            data-question-id="${question.id}"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Your answer"
                            ${question.required ? 'required' : ''}>
                    `;
                } else if (type === 'paragraph') {
                    html += `
                        <textarea 
                            name="${question.id}" 
                            data-question-id="${question.id}"
                            rows="3"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Your answer"
                            ${question.required ? 'required' : ''}></textarea>
                    `;
                } else if (type === 'multiple_choice') {
                    if (question.options && question.options.length > 0) {
                        html += `<div class="space-y-2">`;
                        question.options.forEach((option, idx) => {
                            const optionId = `${question.id}_${idx}`;
                            html += `
                                <div class="flex items-center">
                                    <input type="radio" 
                                        id="${optionId}" 
                                        name="question_${question.id}" 
                                        value="${escapeHtml(option)}"
                                        class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                        ${question.required ? 'required' : ''}>
                                    <label for="${optionId}" class="ml-2 text-sm text-gray-700 cursor-pointer">
                                        ${escapeHtml(option)}
                                    </label>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        html += `<p class="text-gray-500 text-sm italic">No options defined.</p>`;
                    }
                } else if (type === 'checkboxes') {
                    if (question.options && question.options.length > 0) {
                        html += `<div class="space-y-2">`;
                        question.options.forEach((option, idx) => {
                            const optionId = `${question.id}_${idx}`;
                            html += `
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                        id="${optionId}" 
                                        name="question_${question.id}" 
                                        value="${escapeHtml(option)}"
                                        data-question-id="${question.id}"
                                        class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="${optionId}" class="ml-2 text-sm text-gray-700 cursor-pointer">
                                        ${escapeHtml(option)}
                                    </label>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        html += `<p class="text-gray-500 text-sm italic">No options defined.</p>`;
                    }
                } else if (type === 'dropdown') {
                    html += `
                        <select 
                            name="${question.id}" 
                            data-question-id="${question.id}"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            ${question.required ? 'required' : ''}>
                            <option value="">Select an option</option>
                    `;
                    if (question.options && question.options.length > 0) {
                        question.options.forEach(option => {
                            html += `<option value="${escapeHtml(option)}">${escapeHtml(option)}</option>`;
                        });
                    }
                    html += `</select>`;
                } else {
                    // Fallback for unknown types (date, time, etc.) -> Text input
                    html += `
                        <input type="text" 
                            name="${question.id}" 
                            data-question-id="${question.id}"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            ${question.required ? 'required' : ''}>
                    `;
                }

                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        // ============================================
        // FORM SUBMISSION
        // ============================================
        async function handleSubmit(event) {
            event.preventDefault();

            var submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                // Collect answers
                var answers = {};
                var form = window.currentForm;

                form.questions.forEach(function (question) {
                    var questionId = question.id;

                    if (question.type === 'checkboxes') {
                        // Collect all checked values
                        var checkboxes = document.querySelectorAll(`input[data-question-id="${questionId}"]:checked`);
                        answers[questionId] = Array.from(checkboxes).map(function (cb) { return cb.value; });
                    } else if (question.type === 'multiple_choice') {
                        var radio = document.querySelector(`input[name="question_${questionId}"]:checked`);
                        answers[questionId] = radio ? radio.value : null;
                    } else {
                        var input = document.querySelector(`[data-question-id="${questionId}"]`);
                        answers[questionId] = input ? input.value : null;
                    }
                });

                window.Logger.info('Form', 'Submitting answers');

                // Get device ID
                var deviceId = getOrCreateDeviceId();

                // Submit to API
                var formId = getFormIdFromURL();
                var response = await window.API.responses.submit(formId, {
                    answers: answers,
                    device_hash: deviceId
                });

                window.Logger.info('Form', 'Response submitted');

                // API handles cache invalidation for responses


                // Show success state
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');

            } catch (error) {
                window.Logger.error('Form', 'Submission failed', error);

                if (error.status === 409) {
                    // Duplicate submission
                    document.getElementById('form-container').classList.add('hidden');
                    document.getElementById('duplicate-state').classList.remove('hidden');
                } else {
                    alert('Failed to submit response: ' + (error.message || 'Unknown error'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Response';
                }
            }
        }

        // ============================================
        // INITIALIZE ON PAGE LOAD
        // ============================================
        (function () {
            window.Logger.info('Page', 'Initializing fill-form page');

            var formId = getFormIdFromURL();

            if (!formId) {
                window.Logger.error('Page', 'No form ID in URL');
                showError('No Form ID', 'Please access this page with a valid form link.');
                return;
            }

            window.Logger.debug('Page', 'Form ID from URL', formId);

            // Setup form submission
            document.getElementById('response-form').addEventListener('submit', handleSubmit);

            // Load form
            loadForm(formId);
        })();
    </script>

</body>

</html>