<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - EaseForm</title>
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">

    <!-- Tailwind CSS CDN -->
    <!-- Tailwind CSS -->
    <link href="/dist/output.css" rel="stylesheet">

    <!-- Supabase JS Client CDN (UMD build for non-module usage) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Core scripts -->
    <script src="../config.js"></script>
    <script src="../utils/logger.js"></script>
    <script src="../utils/auth.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>

<body
    class="bg-[#0b0c15] min-h-screen flex items-center justify-center p-4 overflow-hidden relative selection:bg-indigo-500/30">

    <!-- Canvas Container for Starfield -->
    <div id="canvas-container" class="fixed inset-0 z-0"></div>

    <!-- Login Card Container -->
    <div class="w-full max-w-md fade-in relative z-10">

        <!-- Login Card with Glassmorphism -->
        <div
            class="bg-slate-900/40 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl shadow-indigo-500/10 p-8 md:p-10 transform transition-all hover:scale-[1.01] duration-500">

            <!-- EaseForm Branding -->

            <div class="text-center mb-10">
                <a href="/" class="inline-flex items-center gap-1 group">
                    <span
                        class="text-3xl font-bold tracking-tight text-white group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-teal-400 group-hover:to-blue-500 transition-all duration-300">Ease</span>
                    <span
                        class="text-3xl font-bold tracking-tight text-teal-400 group-hover:text-white transition-colors duration-300">Form</span>
                    <div class="h-2 w-2 rounded-full bg-teal-400 mb-2 animate-pulse"></div>
                </a>
                <p class="text-slate-400 font-medium mt-3 text-sm">Privacy-first form builder for hosts</p>
            </div>

            <!-- Error Message Display -->
            <div id="errorMessage"
                class="hidden mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-lg backdrop-blur-sm">
                <p class="text-sm text-red-200 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                            clip-rule="evenodd" />
                    </svg>
                    <span id="errorText"></span>
                </p>
            </div>

            <!-- Sign In Instructions -->
            <div class="text-center mb-8">
                <h2 class="text-xl font-semibold text-white mb-2">Welcome back</h2>
                <p class="text-sm text-slate-400">Sign in to manage your forms</p>
            </div>

            <!-- Google Sign In Button -->
            <button type="button" id="googleSignInButton"
                class="w-full bg-white hover:bg-slate-50 text-slate-900 font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-indigo-500/20 flex items-center justify-center group relative overflow-hidden">
                <div
                    class="absolute inset-0 bg-gradient-to-r from-transparent via-slate-100/50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000">
                </div>

                <svg class="w-6 h-6 mr-3 relative z-10" viewBox="0 0 24 24">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                <span class="text-base relative z-10">Sign in with Google</span>
            </button>

            <!-- Privacy Note -->
            <div class="mt-8 pt-6 border-t border-white/10">
                <p class="text-xs text-slate-500 text-center">
                    By signing in, you agree to our Terms of Service.
                    We only use your Google account for authentication.
                </p>
            </div>

        </div>

        <!-- Footer Note -->
        <p class="text-center text-slate-500 text-sm mt-8">
            Respondents don't need to sign in.
        </p>

    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ============================================
        // THREE.JS DEEP SPACE BACKGROUND
        // ============================================
        function initSpaceBackground() {
            const container = document.getElementById('canvas-container');

            // Scene Setup
            const scene = new THREE.Scene();
            // Deep cosmic blue-black fog for depth
            scene.fog = new THREE.FogExp2(0x0b0c15, 0.002);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 100;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Particles (Stars)
            const geometry = new THREE.BufferGeometry();
            const particlesCount = 2000;
            const posArray = new Float32Array(particlesCount * 3);
            const sizesArray = new Float32Array(particlesCount);

            for (let i = 0; i < particlesCount * 3; i += 3) {
                // Spread stars far and wide
                posArray[i] = (Math.random() - 0.5) * 500;   // x
                posArray[i + 1] = (Math.random() - 0.5) * 500; // y
                posArray[i + 2] = (Math.random() - 0.5) * 500; // z

                // Random sizes for depth perception
                sizesArray[i / 3] = Math.random() * 2;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizesArray, 1));

            // Custom Shader Material for soft glowing stars
            // Using PointsMaterial for simplicity and performance first
            const material = new THREE.PointsMaterial({
                size: 1.5,
                color: 0xffffff,
                transparent: true,
                opacity: 0.8,
                sizeAttenuation: true
            });

            // Create Star System
            const starsMesh = new THREE.Points(geometry, material);
            scene.add(starsMesh);

            // Interaction State
            let mouseX = 0;
            let mouseY = 0;
            let targetX = 0;
            let targetY = 0;

            // Event Listeners
            document.addEventListener('mousemove', (event) => {
                mouseX = event.clientX - window.innerWidth / 2;
                mouseY = event.clientY - window.innerHeight / 2;
            });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Animation Loop
            const clock = new THREE.Clock();

            function animate() {
                const elapsedTime = clock.getElapsedTime();

                // Gentle rotation
                starsMesh.rotation.y = elapsedTime * 0.05;
                starsMesh.rotation.x = elapsedTime * 0.02;

                // Parallax easing
                targetX = mouseX * 0.001;
                targetY = mouseY * 0.001;

                // Smoothly interpolate rotation based on mouse
                starsMesh.rotation.y += 0.05 * (targetX - starsMesh.rotation.y);
                starsMesh.rotation.x += 0.05 * (targetY - starsMesh.rotation.x);

                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }

            animate();
        }

        // Initialize background if WebGL is supported
        if (window.WebGLRenderingContext) {
            initSpaceBackground();
        } else {
            Logger.warn('Background', 'WebGL not supported, falling back to CSS gradient');
            // Fallback handled by CSS background color
        }


        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // Wait for config.js to load, then initialize Supabase
        // Credentials are loaded from window.SUPABASE_URL and window.SUPABASE_ANON_KEY
        // NEVER hardcode credentials in this file

        // Get configuration from window (set by config.js)
        var SUPABASE_URL = window.SUPABASE_URL;
        var SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;

        // Validate configuration
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY ||
            SUPABASE_URL.includes('YOUR_') || SUPABASE_ANON_KEY.includes('YOUR_')) {
            Logger.error('Supabase', 'Supabase credentials not configured. Please update config.js with your credentials.');
            showError('Configuration error. Please update config.js with your Supabase credentials.');
        }

        // Initialize Supabase client (using UMD build from unpkg CDN)
        var supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // DOM ELEMENTS
        // ============================================
        var googleSignInButton = document.getElementById('googleSignInButton');
        var errorMessage = document.getElementById('errorMessage');
        var errorText = document.getElementById('errorText');

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        // Show error message to user
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');

            // Auto-hide error after 7 seconds
            setTimeout(function () {
                hideError();
            }, 7000);
        }

        // Hide error message
        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // ============================================
        // AUTH CHECK ON PAGE LOAD
        // ============================================
        // Check if user is already logged in when page loads
        // If they are, redirect them to the dashboard
        function checkExistingSession() {
            supabaseClient.auth.getSession().then(function (response) {
                var session = response.data.session;
                var error = response.error;

                if (error) {
                    Logger.error('Auth', 'Error checking session', error);
                    return;
                }

                if (session) {
                    // User is already logged in, redirect to dashboard
                    Logger.info('Auth', 'User already authenticated, redirecting to dashboard');
                    window.location.href = '/dashboard/';
                }
            }).catch(function (error) {
                Logger.error('Auth', 'Session check failed', error);
            });
        }

        // Run auth check on page load
        checkExistingSession();

        // ============================================
        // GOOGLE OAUTH SIGN IN
        // ============================================
        googleSignInButton.addEventListener('click', function () {
            Logger.info('Auth', 'Google sign-in button clicked');
            hideError();

            // Disable button during sign in
            googleSignInButton.disabled = true;
            googleSignInButton.classList.add('opacity-75', 'cursor-not-allowed');
            var originalHTML = googleSignInButton.innerHTML;
            googleSignInButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Redirecting...</span>';

            // Initiate Google OAuth flow
            supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + '/dashboard/'
                }
            }).then(function (response) {
                var data = response.data;
                var error = response.error;

                if (error) {
                    Logger.error('Auth', 'Google OAuth error', error);
                    showError('Unable to sign in with Google. Please try again or check your internet connection.');

                    // Re-enable button
                    googleSignInButton.disabled = false;
                    googleSignInButton.classList.remove('opacity-75', 'cursor-not-allowed');
                    googleSignInButton.innerHTML = originalHTML;
                    return;
                }

                // User will be redirected to Google's OAuth page
                // After successful auth, they'll be redirected to dashboard
                Logger.info('Auth', 'Initiating Google OAuth', data);

            }).catch(function (error) {
                Logger.error('Auth', 'Google OAuth error', error);
                showError('Unable to sign in with Google. Please try again.');

                // Re-enable button
                googleSignInButton.disabled = false;
                googleSignInButton.classList.remove('opacity-75', 'cursor-not-allowed');
                googleSignInButton.innerHTML = originalHTML;
            });
        });

        // ============================================
        // AUTH STATE LISTENER
        // ============================================
        // Listen for auth state changes (login, logout, token refresh)
        supabaseClient.auth.onAuthStateChange(function (event, session) {
            Logger.debug('Auth', 'Auth state changed', event);

            if (event === 'SIGNED_IN' && session) {
                // User just signed in, redirect to dashboard
                Logger.info('Auth', 'User signed in', 'Redirecting to dashboard');
                window.location.href = '/dashboard/';
            }
        });
    </script>
</body>

</html>