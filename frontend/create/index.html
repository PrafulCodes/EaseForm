<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Form - EaseForm</title>
    <link rel="icon" type="image/png" href="../assets/logo.png">
    <meta name="description" content="Create a new form with EaseForm - Privacy-first form builder">

    <!-- Tailwind CSS CDN -->
    <!-- Tailwind CSS -->
    <link href="/dist/output.css" rel="stylesheet">

    <!-- Supabase JS Client CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Core Utilities -->
    <script src="../config.js"></script>
    <script src="../utils/logger.js"></script>
    <script src="../utils/cache.js"></script>
    <script src="../utils/auth.js"></script>
    <script src="../utils/api.js"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Smooth transitions */
        .question-card {
            transition: all 0.3s ease;
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Toast Notifications */
        .toast {
            min-width: 300px;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Authentication will be checked on page load via JavaScript -->

    <!-- Fixed Header -->
    <header class="bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo and Navigation -->
                <div class="flex items-center">
                    <a href="/dashboard/" class="group flex items-center gap-1">
                        <span
                            class="text-2xl font-bold tracking-tight text-gray-900 group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-indigo-600 group-hover:to-blue-600 transition-all duration-300">Ease</span>
                        <span
                            class="text-2xl font-bold tracking-tight text-indigo-600 group-hover:text-gray-900 transition-colors duration-300">Form</span>
                        <div class="h-2 w-2 rounded-full bg-indigo-600 mb-1 animate-pulse"></div>
                    </a>
                    <span class="mx-3 text-gray-300">|</span>
                    <a href="/dashboard/" class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Dashboard
                    </a>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-3">
                    <button id="previewBtn"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Preview
                    </button>
                    <button id="saveBtn"
                        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">
                        Save Form
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">

        <!-- Form Settings Card -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Form Settings</h2>

            <div class="space-y-4">
                <!-- Form Title -->
                <div>
                    <label for="formTitle" class="block text-sm font-medium text-gray-700 mb-2">Form Title</label>
                    <input type="text" id="formTitle"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="Enter form title" value="Untitled Form">
                </div>

                <!-- Form Description -->
                <div>
                    <label for="formDescription" class="block text-sm font-medium text-gray-700 mb-2">Description
                        (Optional)</label>
                    <textarea id="formDescription" rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                        placeholder="Describe your form"></textarea>
                </div>

                <!-- Privacy Settings -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Built-in Protections</h3>

                    <div class="space-y-3">
                        <label class="flex items-center opacity-75 cursor-not-allowed">
                            <input type="checkbox" id="anonymousResponses" checked disabled
                                class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 bg-gray-100">
                            <div class="ml-2">
                                <span class="text-sm text-gray-700 font-medium">Anonymous responses</span>
                                <p class="text-xs text-gray-500">EaseForm protects respondent privacy by default</p>
                            </div>
                        </label>

                        <label class="flex items-center opacity-75 cursor-not-allowed">
                            <input type="checkbox" id="oneResponsePerDevice" checked disabled
                                class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 bg-gray-100">
                            <div class="ml-2">
                                <span class="text-sm text-gray-700 font-medium">One response per device</span>
                                <p class="text-xs text-gray-500">Prevents spam and duplicate responses</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Section -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Questions</h2>
                <button id="addQuestionBtn"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Question
                </button>
            </div>

            <!-- Questions Container -->
            <div id="questionsContainer" class="space-y-4">
                <!-- Questions will be added here dynamically -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="bg-white rounded-lg shadow-sm p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No questions yet</h3>
                <p class="text-sm text-gray-600 mb-4">Click "Add Question" to start building your form</p>
            </div>
        </div>

    </main>

    <script>
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getFormIdFromURL() {
            var params = new URLSearchParams(window.location.search);
            return params.get('form_id');
        }

        // ============================================
        // TOAST NOTIFICATION SYSTEM
        // ============================================
        function showToast(message, type = 'success', duration = 3000) {
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');
            toast.className = 'toast' + (type === 'error' ? ' error' : '');

            var icon = type === 'success'
                ? '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>'
                : '<svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>';

            toast.innerHTML = `
                <div class="flex items-center">
                    ${icon}
                    <span class="ml-3 text-sm font-medium text-gray-900">${escapeHtml(message)}</span>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(function () {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(function () {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // ============================================
        // CLIPBOARD UTILITY
        // ============================================
        async function copyToClipboard(text, successMessage) {
            try {
                await navigator.clipboard.writeText(text);
                window.Logger.info('Clipboard', 'Copied to clipboard');
                showToast(successMessage || 'Copied to clipboard!', 'success');
            } catch (error) {
                window.Logger.error('Clipboard', 'Failed to copy', error);

                // Fallback for older browsers
                var textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();

                try {
                    document.execCommand('copy');
                    showToast(successMessage || 'Copied to clipboard!', 'success');
                } catch (fallbackError) {
                    showToast('Failed to copy to clipboard', 'error');
                }

                document.body.removeChild(textarea);
            }
        }

        // ============================================
        // SUCCESS MODAL WITH SHARE LINK
        // ============================================
        function showSuccessWithShare(formTitle, shareUrl) {
            // Create modal/notification overlay
            var overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 animate-fadeIn">
                    <div class="text-center mb-4">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Form Created Successfully!</h3>
                        <p class="text-sm text-gray-600 mb-4">${escapeHtml(formTitle)}</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 mb-4">
                        <p class="text-xs text-gray-600 mb-2">Share this link:</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" readonly value="${escapeHtml(shareUrl)}" 
                                   class="flex-1 text-sm bg-white border border-gray-300 rounded px-3 py-2 text-gray-700"
                                   id="share-url-input">
                            <button onclick="copyShareUrl('${escapeHtml(shareUrl)}')" 
                                    class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700">
                                Copy Link
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeSuccessModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                            Close
                        </button>
                        <a href="/app/dashboard.html" 
                           class="flex-1 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 text-center">
                            Go to Dashboard
                        </a>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Make functions globally available
            window.closeSuccessModal = function () {
                document.body.removeChild(overlay);
            };

            window.copyShareUrl = function (url) {
                copyToClipboard(url, 'Form link copied to clipboard!');
            };
        }

        // ============================================
        // USE SHARED SUPABASE CLIENT
        // ============================================
        var supabaseClient = window.supabaseClient;

        if (!supabaseClient) {
            window.Logger.error('App', 'Supabase client not initialized. Check config.js');
        }

        // ============================================
        // GLOBAL STATE
        // ============================================
        var questionCount = 0;
        var questions = [];
        var editingFormId = null; // Store form ID when editing

        // ============================================
        // AUTH PROTECTION (ASYNC)
        // ============================================
        async function initializeCreateForm() {
            try {
                // Wait for session to load
                var response = await supabaseClient.auth.getSession();
                var session = response.data.session;
                var error = response.error;

                if (error) {
                    window.Logger.error('Auth', 'Error checking session', error);
                    window.location.href = '/login/';
                    return;
                }

                // Check if session exists
                if (!session) {
                    window.Logger.info('Auth', 'No session found, redirecting');
                    window.location.href = '/login/';
                    return;
                }

                // Session exists! User is authenticated
                window.Logger.info('Auth', 'User authenticated');

                // Initialize form builder
                initializeFormBuilder();

                // Check if editing existing form
                var formId = getFormIdFromURL();
                if (formId) {
                    window.Logger.info('Form', 'Edit mode - loading form', formId);
                    await loadFormForEdit(formId);
                } else {
                    window.Logger.info('Form', 'Create mode - new form');
                }

            } catch (error) {
                window.Logger.error('Auth', 'Auth check failed', error);
                window.location.href = '/login/';
            }
        }

        // ============================================
        // LOAD FORM FOR EDIT
        // ============================================
        // ============================================
        // LOAD FORM FOR EDIT (WITH CACHING)
        // ============================================
        async function loadFormForEdit(formId) {
            try {
                window.Logger.info('Form', 'Loading form for edit', formId);

                // API handles caching internally
                var form = await window.API.forms.get(formId, function (freshForm) {
                    window.Logger.debug('SWR', 'Updating edit form');
                    displayForm(freshForm);
                });

                window.Logger.info('Form', 'Form loaded for edit');

                displayForm(form);

            } catch (error) {
                window.Logger.error('Form', 'Error loading form', error);

                if (error.status === 404) {
                    showToast('Form not found', 'error');
                    setTimeout(function () {
                        window.location.href = '/app/dashboard.html';
                    }, 2000);
                } else if (error.status === 403) {
                    showToast('You do not have permission to edit this form', 'error');
                    setTimeout(function () {
                        window.location.href = '/app/dashboard.html';
                    }, 2000);
                } else {
                    showToast('Failed to load form: ' + (error.message || 'Unknown error'), 'error');
                }
            }
        }

        function displayForm(form) {
            // Store form ID for save operation
            editingFormId = form.id;

            // Update page title
            document.title = 'Edit Form - EaseForm';

            // Prefill form fields
            prefillFormFields(form);

            // Rebuild questions
            rebuildQuestions(form.questions);
        }

        // ============================================
        // PREFILL FORM FIELDS
        // ============================================
        function prefillFormFields(form) {
            window.Logger.debug('Form', 'Prefilling form fields');

            // Basic fields
            document.getElementById('formTitle').value = form.title || '';
            document.getElementById('formDescription').value = form.description || '';

            // Toggle switches (Always check because they are mandatory)
            document.getElementById('anonymousResponses').checked = true;
            document.getElementById('oneResponsePerDevice').checked = true;
            // 'closeForm' checkbox has been removed from UI

            window.Logger.debug('Form', 'Form fields prefilled');
        }

        // ============================================
        // REBUILD QUESTIONS
        // ============================================
        function rebuildQuestions(questionsData) {
            window.Logger.debug('Form', 'Rebuilding questions', questionsData.length);

            // Clear existing questions
            var container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            // Reset questions array
            questions = [];

            // Hide empty state if there are questions
            if (questionsData.length > 0) {
                document.getElementById('emptyState').style.display = 'none';
            }

            // Rebuild each question
            questionsData.forEach(function (questionData, index) {
                rebuildQuestion(questionData, index);
            });

            window.Logger.debug('Form', 'Questions rebuilt');
        }

        function rebuildQuestion(questionData, index) {
            var questionId = 'question_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            var questionCount = questions.length + 1;

            // Create question card
            var questionCard = document.createElement('div');
            questionCard.id = questionId;
            questionCard.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6';

            questionCard.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Question ${questionCount}</h3>
                    <button type="button" onclick="removeQuestion('${questionId}')" 
                            class="text-red-600 hover:text-red-700 text-sm font-medium">
                        Remove
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                        <input type="text" id="text_${questionId}" value="${escapeHtml(questionData.text || '')}" 
                               placeholder="Enter your question" required
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                        <select id="type_${questionId}" onchange="handleQuestionTypeChange(this, '${questionId}')"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="short_answer" ${questionData.type === 'short_answer' ? 'selected' : ''}>Short Answer</option>
                            <option value="paragraph" ${questionData.type === 'paragraph' ? 'selected' : ''}>Paragraph</option>
                            <option value="multiple_choice" ${questionData.type === 'multiple_choice' ? 'selected' : ''}>Multiple Choice</option>
                            <option value="checkboxes" ${questionData.type === 'checkboxes' ? 'selected' : ''}>Checkboxes</option>
                            <option value="dropdown" ${questionData.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                            <option value="date" ${questionData.type === 'date' ? 'selected' : ''}>Date</option>
                            <option value="time" ${questionData.type === 'time' ? 'selected' : ''}>Time</option>
                        </select>
                    </div>
                    
                    <div id="options_${questionId}" class="options-container">
                        <!-- Options will be added here for choice-based questions -->
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="required_${questionId}" ${questionData.required ? 'checked' : ''}
                               class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
                        <label for="required_${questionId}" class="ml-2 text-sm text-gray-700">Required</label>
                    </div>
                </div>
            `;

            // Add to container
            var container = document.getElementById('questionsContainer');
            container.appendChild(questionCard);

            // Store question data
            questions.push({
                id: questionId,
                number: questionCount
            });

            // Rebuild options if applicable
            if (questionData.type === 'multiple_choice' || questionData.type === 'checkboxes' || questionData.type === 'dropdown') {
                rebuildQuestionOptions(questionId, questionData.options || []);
            }
        }

        function rebuildQuestionOptions(questionId, options) {
            var optionsContainer = document.getElementById('options_' + questionId);

            optionsContainer.innerHTML = `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Options</label>
                    <div id="optionsList_${questionId}" class="space-y-2">
                        <!-- Options will be added here -->
                    </div>
                    <button type="button" onclick="addOption('${questionId}')" 
                            class="mt-2 text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                        + Add Option
                    </button>
                </div>
            `;

            // Add existing options
            options.forEach(function (option) {
                addOptionWithValue(questionId, option);
            });

            // Add one empty option if no options exist
            if (options.length === 0) {
                addOption(questionId);
            }
        }

        function addOptionWithValue(questionId, value) {
            var optionsList = document.getElementById('optionsList_' + questionId);
            if (!optionsList) return;

            var optionId = 'option_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            var optionDiv = document.createElement('div');
            optionDiv.id = optionId;
            optionDiv.className = 'flex items-center space-x-2';
            optionDiv.innerHTML = `
                <input type="text" value="${escapeHtml(value)}" placeholder="Option text" 
                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                <button type="button" onclick="removeOption('${optionId}')" 
                        class="text-red-600 hover:text-red-700 text-sm">
                    Remove
                </button>
            `;

            optionsList.appendChild(optionDiv);
        }

        // ============================================
        // FORM BUILDER INITIALIZATION
        // ============================================
        function initializeFormBuilder() {
            // Add event listeners
            document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
            document.getElementById('saveBtn').addEventListener('click', saveForm);
            document.getElementById('previewBtn').addEventListener('click', previewForm);

            window.Logger.info('Form', 'Form builder initialized');
        }

        // ============================================
        // ADD QUESTION
        // ============================================
        function addQuestion() {
            questionCount++;
            var questionId = 'question_' + questionCount;

            var questionCard = document.createElement('div');
            questionCard.className = 'bg-white rounded-lg shadow-sm p-6 question-card fade-in';
            questionCard.id = questionId;

            questionCard.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1 mr-4">
                        <input 
                            type="text" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="Question ${questionCount}"
                            data-field="question"
                        >
                    </div>
                    <button onclick="removeQuestion('${questionId}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete question">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                    <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" data-field="type" onchange="handleQuestionTypeChange(this, '${questionId}')">
                        <option value="short_answer">Short Answer</option>
                        <option value="paragraph">Paragraph</option>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="checkboxes">Checkboxes</option>
                        <option value="dropdown">Dropdown</option>
                        <option value="linear_scale">Linear Scale</option>
                        <option value="date">Date</option>
                        <option value="time">Time</option>
                    </select>
                </div>
                
                <div class="options-container" id="options_${questionId}">
                    <!-- Options will be added here for choice-based questions -->
                </div>
                
                <div class="flex items-center pt-4 border-t border-gray-200">
                    <label class="flex items-center">
                        <input type="checkbox" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" data-field="required">
                        <span class="ml-2 text-sm text-gray-700">Required</span>
                    </label>
                </div>
            `;

            // Add to container
            var container = document.getElementById('questionsContainer');
            container.appendChild(questionCard);

            // Hide empty state
            document.getElementById('emptyState').style.display = 'none';

            // Store question data
            questions.push({
                id: questionId,
                number: questionCount
            });
        }

        // ============================================
        // REMOVE QUESTION
        // ============================================
        function removeQuestion(questionId) {
            var card = document.getElementById(questionId);
            if (card) {
                card.remove();

                // Remove from questions array
                questions = questions.filter(function (q) { return q.id !== questionId; });

                // Show empty state if no questions
                if (questions.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                }
            }
        }

        // ============================================
        // HANDLE QUESTION TYPE CHANGE
        // ============================================
        // ============================================
        // HANDLE QUESTION TYPE CHANGE
        // ============================================
        var savedOptions = {}; // Store options when switching types

        function handleQuestionTypeChange(select, questionId) {
            var type = select.value;
            var optionsContainer = document.getElementById('options_' + questionId);

            // 1. Save current options if we are switching FROM a choice type
            // Check if we have existing options inputs
            var currentInputs = optionsContainer.querySelectorAll('input[type="text"]');
            if (currentInputs.length > 0) {
                var currentValues = Array.from(currentInputs).map(i => i.value);
                savedOptions[questionId] = currentValues;
                window.Logger.debug('Form', 'Saved options');
            }

            // 2. Clear existing options UI
            optionsContainer.innerHTML = '';

            // 3. Add options UI for choice-based questions
            if (type === 'multiple_choice' || type === 'checkboxes' || type === 'dropdown') {
                optionsContainer.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Options</label>
                        <div class="space-y-2" id="optionsList_${questionId}">
                        </div>
                        <button type="button" onclick="addOption('${questionId}')" 
                                class="mt-2 text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                            + Add Option
                        </button>
                    </div>
                `;

                var optionsList = document.getElementById('optionsList_' + questionId);

                // 4. Restore saved options OR add default empty one
                if (savedOptions[questionId] && savedOptions[questionId].length > 0) {
                    window.Logger.debug('Form', 'Restoring options', questionId);
                    savedOptions[questionId].forEach(val => {
                        var optionDiv = createOptionElement(val);
                        optionsList.appendChild(optionDiv);
                    });
                } else {
                    // Default empty option
                    var optionDiv = createOptionElement('');
                    optionsList.appendChild(optionDiv);
                }
            }
        }

        // Helper to create option element
        function createOptionElement(value) {
            var optionCount = document.querySelectorAll('.options-container input').length + 1; // Approximate
            var optionId = 'option_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            var div = document.createElement('div');
            div.className = 'flex items-center space-x-2 fade-in';
            div.id = optionId;
            div.innerHTML = `
                <input type="text" value="${escapeHtml(value)}" 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
                       placeholder="Option">
                <button type="button" onclick="removeOption('${optionId}')" 
                        class="text-red-600 hover:text-red-700 text-sm">
                    Remove
                </button>
            `;
            return div;
        }

        // ============================================
        // ADD OPTION
        // ============================================
        function addOption(questionId) {
            var optionsList = document.getElementById('optionsList_' + questionId);
            if (!optionsList) return; // Guard

            var optionDiv = createOptionElement('');
            optionsList.appendChild(optionDiv);
        }

        // ============================================
        // SAVE FORM
        // ============================================
        async function saveForm() {
            // Construct flat payload matching backend Pydantic Create/Update models
            var formData = {
                title: document.getElementById('formTitle').value,
                description: document.getElementById('formDescription').value,
                is_active: true,
                // Force privacy settings (matched backend enforcement)
                anonymous: true,
                one_response_per_device: true,
                // closed: false // Default to false, handled by backend
                questions: []
            };

            // Collect all questions
            var questionCards = document.querySelectorAll('.question-card');
            questionCards.forEach(function (card) {
                var questionData = {
                    id: card.id,  // Add question ID (e.g., "question_1")
                    question: card.querySelector('[data-field="question"]').value,
                    type: card.querySelector('[data-field="type"]').value,
                    required: card.querySelector('[data-field="required"]').checked,
                    options: []
                };

                // Collect options if applicable
                var optionsInputs = card.querySelectorAll('.options-container input[type="text"]');
                optionsInputs.forEach(function (input) {
                    if (input.value.trim()) {
                        questionData.options.push(input.value.trim());
                    }
                });

                formData.questions.push(questionData);
            });

            window.Logger.debug('Form', 'Form data', formData);

            // Save to backend via API
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                var response;

                // Check if editing or creating
                if (editingFormId) {
                    window.Logger.info('Form', 'Updating form', editingFormId);
                    response = await window.API.forms.update(editingFormId, formData);
                    window.Logger.info('Form', 'Form updated');

                    // Invalidate cache
                    window.CacheUtils.clear();

                    showToast('Form updated successfully!', 'success');

                    // Redirect to dashboard after update
                    setTimeout(function () {
                        window.location.href = '/app/dashboard.html';
                    }, 1500);
                } else {
                    window.Logger.info('Form', 'Creating new form');
                    response = await window.API.forms.create(formData);
                    window.Logger.info('Form', 'Form created');

                    // Invalidate cache
                    window.CacheUtils.clear();

                    // Generate share URL
                    var formId = response.id;
                    var shareUrl = window.location.origin + '/forms/?id=' + formId;

                    window.Logger.info('Form', 'Share URL generated');

                    // Show success notification with share link
                    showSuccessWithShare(response.title, shareUrl);
                }

            } catch (error) {
                window.Logger.error('Form', 'Error saving form', error);
                showToast('Failed to save form: ' + (error.message || 'Unknown error'), 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Form';
            }
        }

        // ============================================
        // PREVIEW FORM
        // ============================================
        function previewForm() {
            alert('Preview functionality coming soon!');
            // TODO: Open preview in new tab or modal
        }

        // Initialize on page load
        initializeCreateForm();
    </script>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

</body>

</html>